rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isOwner(storeId) {
      return request.auth != null && request.auth.uid == storeId;
    }

    function hasOnlyValidStatsKeys() {
      let validKeys = [
        'totalWallets', 'totalBalance', 'totalTransactions', 
        'sendCount', 'receiveCount', 'totalSentAmount', 'totalReceivedAmount', 
        'totalCommission', 'openDebtsCount', 'paidDebtsCount', 
        'totalOpenAmount', 'totalPaidAmount', 'lastUpdated'
      ];
      return request.resource.data.keys().hasOnly(validKeys);
    }

    function allFieldsAreNumericOrTimestamp() {
      let data = request.resource.data;
      return 
        (data.totalWallets is int) &&
        (data.totalBalance is number) &&
        (data.totalTransactions is int) &&
        (data.sendCount is int) &&
        (data.receiveCount is int) &&
        (data.totalSentAmount is number) &&
        (data.totalReceivedAmount is number) &&
        (data.totalCommission is number) &&
        (data.openDebtsCount is int) &&
        (data.paidDebtsCount is int) &&
        (data.totalOpenAmount is number) &&
        (data.totalPaidAmount is number) &&
        (data.lastUpdated is timestamp);
    }

    // --- Top-Level Collections ---
    match /license_keys/{keyId} {
      allow list: if request.query.limit == 1;
      allow get: if request.auth != null;
      allow update: if request.auth != null && request.resource.data.usedBy == request.auth.uid;
      allow create, delete: if false;
    }

    match /stores/{storeId} {
      allow list: if request.query.limit == 1;
      allow get: if isOwner(storeId);
      allow create: if request.auth.uid == storeId && request.resource.data.ownerId == request.auth.uid;
      allow update: if isOwner(storeId);
      allow delete: if false; // Stores cannot be deleted from the client.

      // --- Nested Statistics Sub-collection ---
      match /stats/summary {
        allow get, read: if isOwner(storeId);
        
        // Allow creation only for initialization with valid fields.
        allow create: if isOwner(storeId) && hasOnlyValidStatsKeys() && allFieldsAreNumericOrTimestamp();
        
        // Allow updates only for atomic increments or valid field changes.
        // This rule is permissive to allow FieldValue.increment, which can't be strictly validated here.
        // The hasOnlyValidStatsKeys function ensures no malicious fields are added.
        allow update: if isOwner(storeId) && hasOnlyValidStatsKeys();

        allow delete: if false;
      }
    }

    match /users/{userId} {
      allow list: if request.query.limit == 1 || request.auth != null;
      allow get: if isOwner(resource.data.storeId);
      allow create: if isOwner(request.resource.data.storeId);
      allow update: if isOwner(resource.data.storeId);
      allow delete: if isOwner(resource.data.storeId);
    }

    // --- Store-Specific Sub-collections (More secure rules) ---
    // Note: These rules are kept as per instructions but could be more secure.
    // For example, list operations should ideally validate the storeId from the query.
    // e.g., allow list: if isOwner(request.query.storeId);

    match /wallets/{walletId} {
      allow get: if isOwner(resource.data.storeId);
      allow list: if request.auth != null; // Kept as is
      allow create: if isOwner(request.resource.data.storeId);
      allow update: if isOwner(resource.data.storeId);
      allow delete: if isOwner(resource.data.storeId);
    }

    match /transactions/{transactionId} {
      allow get: if isOwner(resource.data.storeId);
      allow list: if request.auth != null; // Kept as is
      allow create: if isOwner(request.resource.data.storeId);
      allow update: if isOwner(resource.data.storeId);
      allow delete: if isOwner(resource.data.storeId);
    }

    match /debts/{debtId} {
      allow get: if isOwner(resource.data.storeId);
      allow list: if request.auth != null; // Kept as is
      allow create: if isOwner(request.resource.data.storeId);
      allow update: if isOwner(resource.data.storeId);
      allow delete: if isOwner(resource.data.storeId);
    }
  }
}